@using Localization
@using WebApplication.Models
@model SiteAndMonthViewModel
@{
    var month = Model.Month;
    var site = Model.Site;
    ViewBag.Title = Html.DisplayFor(model => model.Month.MonthTime, "MonthYearDateTime");
    ViewBag.Link = Html.ActionLink("Back to " + Resources.LabelPerformanceData, "Index", "Months", new { id = month.SiteId }, null);
}
@Html.Partial("_PageTitlePartial")
@Html.Partial("_SiteDetailsPartial", site)

@* VISITOR CYCLE NAVIGATION *@
<div class="row">
    <div role="tablist" id="tabs" style="margin-bottom: 10px;" class="col-sm-10">
        <ul id="monthTab" class="nav nav-tabs">
            <li role="presentation" class="active">
                <a href="#Attention" data-toggle="tab">
                    Marketing
                </a>
            </li>
            <li role="presentation">
                <a href="#Arriving" data-toggle="tab">
                    Arriving
                </a>
            </li>
            <li role="presentation">
                <a href="#Shopping" data-toggle="tab">
                    Shopping
                </a>
            </li>
            <li role="presentation">
                <a href="#Refreshment" data-toggle="tab">
                    Refreshment
                </a>
            </li>
            <li role="presentation">
                <a href="#Donation" data-toggle="tab">
                    Donation
                </a>
            </li>
            <li role="presentation">
                <a href="#Experience" data-toggle="tab">
                    Experience
                </a>
            </li>
        </ul>
    </div>
</div>
@using (Html.BeginForm())
{
    @* MONTHLY PERFORMANCE DATA FORM *@
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
    @Html.Hidden("SiteId", month.SiteId)
    @Html.Hidden("MonthTime", month.MonthTime)
    <div class="tab-content">
        <div class="tab-pane in active" id="Attention">
            @Html.Partial("_Attention", month)
        </div>
        <div class="tab-pane" id="Arriving">
            @Html.Partial("_Arriving", month)
        </div>
        <div class="tab-pane" id="Shopping">
            @Html.Partial("_Shopping", month)
        </div>
        <div class="tab-pane" id="Refreshment">
            @Html.Partial("_Refreshment", month)
        </div>
        <div class="tab-pane" id="Donation">
            @Html.Partial("_Donation", month)
        </div>
        <div class="tab-pane" id="Experience">
            @Html.Partial("_Experience", month)
        </div>
    </div>
    <div class="row">
        <div class="form-group col-md-9">
            <input id="previous" type="submit" value="<< Save and Previous" class="btn btn-primary" />
            <input id="next" type="submit" value="Save and Next >>" class="btn btn-primary" />
        </div>
    </div>
}
@section scripts
{
    <script type="text/javascript">
        // ---------------------
        // PRESERVE TAB
        // ---------------------
        // Preserve the selected tab between postbacks and visits
        // Adapted from https://gist.github.com/brendanmckenzie/8f8008d3d51c07b2700f
        // but using the month.id as key to it is unique to each month.
        // ---------------------
        $(function () {
            'use strict';
            // When the tab is clicked stash the name in local storage.
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                var id = $(this).parents('[role="tablist"]').attr('id');
                var key = document.URL.split("/").pop();
                key = key.substring(0, key.indexOf('?'));
                if (id) {
                    key += ':' + id;
                }
                console.log(key);
                var tab = $(e.target).attr('href');
                console.log(tab);
                localStorage.setItem(key, $(e.target).attr('href'));
            });

            // When the page is loaded set the tab to the value in local storage.
            $('[role="tablist"]').each(function (idx, elem) {
                var id = $(elem).attr('id');
                var key = document.URL.split("/").pop();
                key = key.substring(0, key.indexOf('?'));
                if (id) {
                    key += ':' + id;
                }
                var lastTab = localStorage.getItem(key);
                if (lastTab) {
                    $('[href="' + lastTab + '"]').tab('show');
                }

            });

            // Hide the buttons that aren't relevant.
            var index = $('ul#monthTab li').index($('.active'));
            if (index == 0) $('#previous').hide();
        });

        //$('#VisitorsPercentNoFamily').tooltip({ 'trigger': 'focus', 'title': 'Password tooltip' });
        //$('input[type="number"]').focus(function () {
        //    alert("Handler for .focus() called.");
        //});

        // ---------------------
        // ATTENTION
        // ---------------------

        // ---------------------
        // ARRIVING
        // ---------------------
        // TODO: Dry this out a bit.
        // Calculate the total percentage to give the user feedback about that
        // the market segmentation figurers are related.
        // ---------------------
        $(document).ready(AddUpMarketSegmentation);
        $('#MarketSegmentation input').bind("keyup", AddUpMarketSegmentation);
        $('#MarketSegmentation input').bind("mousewheel", AddUpMarketSegmentation);
        $('#MarketSegmentation input').bind("input", AddUpMarketSegmentation);
        function AddUpMarketSegmentation() {
            var sum = 0;
            $('#MarketSegmentation input').each(function () {
                sum += Number($(this).val());
            });
            $('#MarketSegmentationTotal').text(sum);
        }

        // ---------------------
        // Calculate the total number of visitors to provide user feedback.
        // ---------------------
        $(document).ready(AddUpVisitors);
        $('#Visitors input').bind("keyup", AddUpVisitors);
        $('#Visitors input').bind("mousewheel", AddUpVisitors);
        $('#Visitors input').bind("input", AddUpVisitors);
        function AddUpVisitors() {
            var sum = 0;
            $('#Visitors input').each(function () {
                sum += Number($(this).val());
            });
            $('#VisitorsTotal').text(sum);
        }

        // TODO: Dry this out a bit.
        // ---------------------
        // SHOPPING
        // ---------------------
        $(document).ready(function () {
            // Attach a function to the change event
            $('input:radio[name=IsRetail]').change(function () {
                var checkedValue = $("input[name=IsRetail]:checked").val();
                if (checkedValue == "true")
                    $('#Retail').fadeIn();
                else
                    $('#Retail').hide();
            });
            // Call the event so the div is set correctly
            $('#IsRetail').change();
        });

        // ---------------------
        // REFRESHMENT
        // ---------------------
        $(document).ready(function () {
            $('input:radio[name=IsCatering]').change(function () {
                var checkedValue = $("input[name=IsCatering]:checked").val();
                if (checkedValue == "true")
                    $('#Catering').fadeIn();
                else
                    $('#Catering').hide();
            });
            // Call the event so the div is set correctly
            $('#IsCatering').change();
        });

        // ---------------------
        // DONATION
        // ---------------------
        $(document).ready(function () {
            // Attach a function to the change event
            $('input:radio[name=IsDonationOpportunity]').change(function () {
                var checkedValue = $("input[name=IsDonationOpportunity]:checked").val();
                if (checkedValue == "true")
                    $('#DonationOpportunity').fadeIn();
                else
                    $('#DonationOpportunity').hide();
            });
            // Call the event so the div is set correctly
            $('#IsDonationOpportunity').change();
        });

        // ---------------------
        // EXPERIENCE
        // ---------------------
        $(document).ready(function () {
            // Attach a function to the change event
            $('input:radio[name=IsAdditionalEvents]').change(function () {
                var checkedValue = $("input[name=IsAdditionalEvents]:checked").val();
                if (checkedValue == "true")
                    $('#Events').fadeIn();
                else
                    $('#Events').hide();
            });
            // Call the event so the div is set correctly
            $('#IsAdditionalEvents').change();
        });

        $(document).ready(function () {
            // Attach a function to the change event
            $('#IsCollectionsOutstanding').change(function () {
                if (this.checked)
                    $('#CollectionsOutstanding').fadeIn();
                else
                    $('#CollectionsOutstanding').hide();
            });
            // Call the event so the div is set correctly
            $('#IsCollectionsOutstanding').change();
        });

    </script>
}
